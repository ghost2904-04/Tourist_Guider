<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Tracking - Tourist Safety System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .header .subtitle {
      opacity: 0.9;
      font-size: 1rem;
    }

    .back-btn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .main-content {
      padding: 2.5rem;
    }

    .status-panel {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e0e0e0;
      margin-bottom: 2rem;
      text-align: center;
    }

    .tracking-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .status-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-active {
      background: #28a745;
    }

    .status-inactive {
      background: #dc3545;
    }

    .status-pending {
      background: #ffc107;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }

    .btn-danger:hover {
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .btn-success:hover {
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid #e0e0e0;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f0f0f0;
    }

    .card-header h2 {
      color: #333;
      font-size: 1.3rem;
    }

    .current-location {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
      border: 1px solid #28a745;
    }

    .location-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #667eea;
    }

    .location-item:last-child {
      margin-bottom: 0;
    }

    .location-time {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .location-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
    }

    .location-coords {
      color: #888;
      font-size: 0.85rem;
      font-family: monospace;
    }

    .location-speed {
      color: #667eea;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .notification {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 2rem;
      font-weight: 500;
      text-align: center;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }

    .notification.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .notification.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .notification.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .emergency-panel {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }

    .emergency-btn {
      background: white;
      color: #dc3545;
      font-size: 1.2rem;
      font-weight: 700;
      padding: 1rem 2rem;
      margin-top: 1rem;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-item {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .main-content {
        padding: 1.5rem;
      }

      .header {
        padding: 1.5rem;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .controls {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container fade-in">
    <div class="header">
      <a href="./trip_manager.html" class="back-btn">‚Üê Back to Trips</a>
      <h1>üìç Location Tracking</h1>
      <p class="subtitle" id="trip-title">Real-time safety monitoring</p>
    </div>

    <div class="main-content">
      <!-- Notification area -->
      <div id="notification" class="notification hidden"></div>

      <!-- Emergency Panel -->
      <div class="emergency-panel" id="emergency-panel" style="display: none;">
        <h2>üö® Emergency Mode Active</h2>
        <p>Your location is being tracked and emergency contacts have been notified.</p>
        <button class="emergency-btn btn" onclick="deactivateEmergency()">
          Deactivate Emergency Mode
        </button>
      </div>

      <!-- Status Panel -->
      <div class="status-panel">
        <div class="tracking-status">
          <div class="status-indicator status-inactive" id="status-indicator"></div>
          <h2 id="tracking-status-text">Location Tracking Inactive</h2>
        </div>
        
        <div class="controls">
          <button class="btn btn-success" id="start-btn" onclick="startTracking()">
            <span>‚ñ∂Ô∏è</span> Start Tracking
          </button>
          <button class="btn btn-danger" id="stop-btn" onclick="stopTracking()" disabled>
            <span>‚èπÔ∏è</span> Stop Tracking
          </button>
          <button class="btn" onclick="getCurrentLocation()">
            <span>üéØ</span> Get Current Location
          </button>
          <button class="btn btn-danger" onclick="activateEmergency()">
            <span>üö®</span> Emergency
          </button>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value" id="locations-count">0</div>
          <div class="stat-label">Locations Recorded</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="tracking-time">0m</div>
          <div class="stat-label">Tracking Time</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="last-update">--</div>
          <div class="stat-label">Last Update</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="safety-status">Safe</div>
          <div class="stat-label">Safety Status</div>
        </div>
      </div>

      <!-- Content Grid -->
      <div class="grid">
        <!-- Current Location -->
        <div class="card current-location">
          <div class="card-header">
            <span style="font-size: 1.5rem;">üéØ</span>
            <h2>Current Location</h2>
          </div>
          <div id="map" style="width:100%; height:300px; border-radius:12px; margin-bottom:1rem;"></div>
          <div id="current-location-content">
            <div class="empty-state">
              <div class="icon">üìç</div>
              <h3>Location not available</h3>
              <p>Start tracking to see your current location</p>
            </div>
          </div>
        </div>

        <!-- Trip Information -->
        <div class="card">
          <div class="card-header">
            <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
            <h2>Trip Information</h2>
          </div>
          <div id="trip-info">
            <p><strong>Trip:</strong> <span id="trip-name">Loading...</span></p>
            <p><strong>Destination:</strong> <span id="trip-destination">Loading...</span></p>
            <p><strong>Duration:</strong> <span id="trip-duration">Loading...</span></p>
            <p><strong>Status:</strong> <span id="trip-status">Loading...</span></p>
          </div>
        </div>
      </div>

      <!-- Location History -->
      <div class="card">
        <div class="card-header">
          <span style="font-size: 1.5rem;">üìã</span>
          <h2>Location History</h2>
          <button class="btn" onclick="exportLocations()" style="margin-left: auto; padding: 8px 16px; font-size: 14px;">
            üíæ Export
          </button>
        </div>
        <div id="location-list">
          <div class="empty-state">
            <div class="icon">üìç</div>
            <h3>No locations recorded</h3>
            <p>Start tracking to see your location history</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Configuration
    const SUPABASE_URL = "https://martdbudgoflarqthipw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hcnRkYnVkZ29mbGFycXRoaXB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMzg0NzcsImV4cCI6MjA3MzcxNDQ3N30.XxB8CbFakk_SJBvIC873k8vTh9z82VC1OKG-xQtRMWE";
    const GOOGLE_MAPS_API_KEY = "AIzaSyB9JtaoGZvW33eY4XrbXYHpKZGrl3YyFBY";

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State management
    let currentUser = null;
    let currentTrip = null;
    let currentDeviceId = null;
    let trackingInterval = null;
    let startTime = null;
    let isTracking = false;
    let isEmergencyMode = false;
    let locations = [];
    let map = null;
    let marker = null;
    let historyMarkers = [];
    let pathPolyline = null;

    // DOM Elements
    const notificationEl = document.getElementById("notification");
    const statusIndicator = document.getElementById("status-indicator");
    const statusText = document.getElementById("tracking-status-text");
    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const locationList = document.getElementById("location-list");
    const currentLocationContent = document.getElementById("current-location-content");

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 20.5937, lng: 78.9629 },
        zoom: 5,
      });

      // Initialize polyline for location history path
      pathPolyline = new google.maps.Polyline({
        path: [],
        geodesic: true,
        strokeColor: "#667eea",
        strokeOpacity: 1.0,
        strokeWeight: 2,
        map: map,
      });
    }

    function updateMap(lat, lon) {
      if (!map) return;
      const pos = { lat: lat, lng: lon };

      if (!marker) {
        marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: "Your Current Location",
        });
      } else {
        marker.setPosition(pos);
      }

      map.setCenter(pos);
      map.setZoom(15);
    }

    function updateCurrentLocation(lat, lon, locationName, speed) {
      const speedText = speed ? `${(speed * 3.6).toFixed(1)} km/h` : "Stationary";

      currentLocationContent.innerHTML = `
        <div class="location-item">
          <div class="location-time">${new Date().toLocaleString()}</div>
          <div class="location-name">${locationName}</div>
          <div class="location-coords">${formatCoordinate(lat)}, ${formatCoordinate(lon)}</div>
          <div class="location-speed">Speed: ${speedText}</div>
        </div>
      `;

      updateMap(lat, lon);
    }

    function renderLocationHistory() {
      if (locations.length === 0) {
        locationList.innerHTML = `
          <div class="empty-state">
            <div class="icon">üìç</div>
            <h3>No locations recorded</h3>
            <p>Start tracking to see your location history</p>
          </div>
        `;
        return;
      }

      // Clear old markers
      historyMarkers.forEach(m => m.setMap(null));
      historyMarkers = [];
      pathPolyline.setPath([]);

      const locationsHTML = locations.map(location => {
        const time = new Date(location.recorded_at).toLocaleString();
        const speed = location.speed ? `${(location.speed * 3.6).toFixed(1)} km/h` : "Stationary";
        const safetyClass = location.safety_response === 3 ? "border-left-color: #dc3545;" : "";

        // Add marker for history point
        const pos = { lat: location.latitude, lng: location.longitude };
        const marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: `${location.location_name} @ ${time}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 5,
            fillColor: location.safety_response === 3 ? "#dc3545" : "#667eea",
            fillOpacity: 1,
            strokeWeight: 0,
          },
        });
        historyMarkers.push(marker);

        // Extend polyline path
        const path = pathPolyline.getPath();
        path.push(pos);

        return `
          <div class="location-item" style="${safetyClass}">
            <div class="location-time">${time}</div>
            <div class="location-name">${location.location_name}</div>
            <div class="location-coords">${formatCoordinate(location.latitude)}, ${formatCoordinate(location.longitude)}</div>
            <div class="location-speed">Speed: ${speed}</div>
          </div>
        `;
      }).join("");

      locationList.innerHTML = locationsHTML;
    }

    // Utility functions
    function showNotification(message, type = 'info') {
      notificationEl.className = `notification ${type}`;
      notificationEl.textContent = message;
      notificationEl.classList.remove('hidden');
      notificationEl.classList.add('show');
      
      setTimeout(() => {
        notificationEl.classList.remove('show');
        setTimeout(() => notificationEl.classList.add('hidden'), 300);
      }, 5000);
    }

    function updateTrackingStatus(tracking) {
      isTracking = tracking;
      
      if (tracking) {
        statusIndicator.className = "status-indicator status-active";
        statusText.textContent = "Location Tracking Active";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } else {
        statusIndicator.className = "status-indicator status-inactive";
        statusText.textContent = "Location Tracking Inactive";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    function formatTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      
      if (hours > 0) {
        return `${hours}h ${mins}m`;
      }
      return `${mins}m`;
    }

    function formatCoordinate(coord) {
      return coord ? coord.toFixed(6) : 'Unknown';
    }

    function updateStats() {
      document.getElementById('locations-count').textContent = locations.length;
      
      if (startTime && isTracking) {
        const elapsed = Math.floor((Date.now() - startTime) / (1000 * 60));
        document.getElementById('tracking-time').textContent = formatTime(elapsed);
      }
      
      if (locations.length > 0) {
        const lastLocation = locations[0];
        const lastUpdate = new Date(lastLocation.recorded_at).toLocaleTimeString();
        document.getElementById('last-update').textContent = lastUpdate;
      }
      
      document.getElementById('safety-status').textContent = isEmergencyMode ? 'Emergency' : 'Safe';
    }

    // Geolocation functions
    async function reverseGeocode(lat, lon) {
      try {
        const response = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&key=${GOOGLE_MAPS_API_KEY}`
        );
        const data = await response.json();
        
        if (data.status === 'OK' && data.results.length > 0) {
          return data.results[0].formatted_address;
        }
        return `${formatCoordinate(lat)}, ${formatCoordinate(lon)}`;
      } catch (error) {
        console.error('Reverse geocoding error:', error);
        return `${formatCoordinate(lat)}, ${formatCoordinate(lon)}`;
      }
    }

    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('Geolocation is not supported by this browser'));
          return;
        }

        navigator.geolocation.getCurrentPosition(
          position => resolve(position),
          error => reject(error),
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000
          }
        );
      });
    }

    // Device management
    async function registerDevice() {
      if (currentDeviceId) return currentDeviceId;

      try {
        // Try from localStorage first
        currentDeviceId = localStorage.getItem("deviceId");
        if (currentDeviceId) {
          // Verify device exists in database
          const { data, error } = await db
            .from("devices")
            .select("id")
            .eq("id", currentDeviceId)
            .single();
          
          if (data && !error) return currentDeviceId;
        }

        // Create new device
        const os = navigator.userAgent.includes("Android") ? "Android" :
                  navigator.userAgent.includes("iPhone") ? "iOS" : "Web";

        const deviceData = {
          profile_id: currentUser.id,
          device_id: crypto.randomUUID(),
          os: os,
          last_seen: new Date().toISOString()
        };

        const { data, error } = await db
          .from("devices")
          .insert(deviceData)
          .select()
          .single();

        if (error) throw error;

        currentDeviceId = data.id;
        localStorage.setItem("deviceId", currentDeviceId);
        return currentDeviceId;

      } catch (error) {
        console.error("Device registration error:", error);
        showNotification("Error registering device: " + error.message, 'error');
        return null;
      }
    }

    // Location tracking
    async function logLocation(lat, lon, speed, locationName) {
      try {
        const locationData = {
          trip_id: currentTrip.id,
          device_id: currentDeviceId,
          latitude: lat,
          longitude: lon,
          speed: speed,
          location_name: locationName,
          safety_response: isEmergencyMode ? 3 : 1, // 3 = emergency, 1 = safe
          recorded_at: new Date().toISOString()
        };

        const { error } = await db
          .from("trip_locations")
          .insert(locationData);

        if (error) throw error;

        // Update device last_seen
        await db
          .from("devices")
          .update({ last_seen: new Date().toISOString() })
          .eq("id", currentDeviceId);

        // Add to local array for immediate UI update
        locations.unshift(locationData);
        
        // Update UI
        updateCurrentLocation(lat, lon, locationName, speed);
        renderLocationHistory();
        updateStats();

      } catch (error) {
        console.error("Location logging error:", error);
        showNotification("Error saving location: " + error.message, 'error');
      }
    }

    async function getCurrentLocation() {
      try {
        showNotification('Getting current location...', 'info');
        
        const position = await getCurrentPosition();
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        const speed = position.coords.speed;

        const locationName = await reverseGeocode(lat, lon);
        
        updateCurrentLocation(lat, lon, locationName, speed);
        showNotification('Location updated successfully!', 'success');

      } catch (error) {
        console.error('Get location error:', error);
        showNotification('Error getting location: ' + error.message, 'error');
      }
    }

    async function startTracking() {
      try {
        if (!currentTrip) {
          showNotification('No active trip found', 'error');
          return;
        }

        if (!currentDeviceId) {
          await registerDevice();
          if (!currentDeviceId) return;
        }

        // Test location access first
        await getCurrentPosition();
        
        startTime = Date.now();
        updateTrackingStatus(true);
        showNotification('Location tracking started', 'success');

        // Start periodic location updates (every 15 seconds)
        trackingInterval = setInterval(async () => {
          try {
            const position = await getCurrentPosition();
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const speed = position.coords.speed;

            const locationName = await reverseGeocode(lat, lon);
            await logLocation(lat, lon, speed, locationName);

          } catch (error) {
            console.error('Tracking error:', error);
            showNotification('Tracking error: ' + error.message, 'error');
          }
        }, 15000);

        // Update tracking time every minute
        setInterval(() => {
          if (isTracking) {
            updateStats();
          }
        }, 60000);

      } catch (error) {
        console.error('Start tracking error:', error);
        showNotification('Error starting tracking: ' + error.message, 'error');
      }
    }

    function stopTracking() {
      if (trackingInterval) {
        clearInterval(trackingInterval);
        trackingInterval = null;
      }

      startTime = null;
      updateTrackingStatus(false);
      showNotification('Location tracking stopped', 'info');
    }

    // Emergency functions
    function activateEmergency() {
      if (!confirm('This will activate emergency mode and notify your emergency contacts. Continue?')) {
        return;
      }

      isEmergencyMode = true;
      document.getElementById('emergency-panel').style.display = 'block';
      document.getElementById('safety-status').textContent = 'Emergency';
      document.getElementById('safety-status').style.color = '#dc3545';
      
      showNotification('Emergency mode activated! Your location is being monitored.', 'error');
      
      // Start tracking if not already active
      if (!isTracking) {
        startTracking();
      }
    }

    function deactivateEmergency() {
      isEmergencyMode = false;
      document.getElementById('emergency-panel').style.display = 'none';
      document.getElementById('safety-status').textContent = 'Safe';
      document.getElementById('safety-status').style.color = '#28a745';
      
      showNotification('Emergency mode deactivated', 'success');
    }

    // Data loading and rendering
    async function loadTripInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      const tripId = urlParams.get('trip');

      if (!tripId) {
        showNotification('No trip specified', 'error');
        return false;
      }

      try {
        const { data, error } = await db
          .from("trips")
          .select("*")
          .eq("id", tripId)
          .eq("profile_id", currentUser.id)
          .single();

        if (error || !data) {
          throw new Error('Trip not found');
        }

        currentTrip = data;
        
        // Update UI
        document.getElementById('trip-title').textContent = `Tracking: ${data.trip_name || 'Unnamed Trip'}`;
        document.getElementById('trip-name').textContent = data.trip_name || 'Unnamed Trip';
        document.getElementById('trip-destination').textContent = data.destination || 'Not specified';
        
        const startDate = new Date(data.start_date);
        const endDate = new Date(data.end_date);
        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        document.getElementById('trip-duration').textContent = `${duration} days`;
        
        const now = new Date();
        let status = 'Unknown';
        if (now < startDate) status = 'Upcoming';
        else if (now >= startDate && now <= endDate) status = 'Active';
        else status = 'Completed';
        
        document.getElementById('trip-status').textContent = status;

        return true;

      } catch (error) {
        console.error('Load trip error:', error);
        showNotification('Error loading trip information', 'error');
        return false;
      }
    }

    async function loadLocationHistory() {
      if (!currentTrip) return;

      try {
        const { data, error } = await db
          .from("trip_locations")
          .select("*")
          .eq("trip_id", currentTrip.id)
          .order("recorded_at", { ascending: false })
          .limit(50);

        if (error) throw error;

        locations = data || [];
        renderLocationHistory();
        updateStats();

      } catch (error) {
        console.error('Load locations error:', error);
        showNotification('Error loading location history', 'error');
      }
    }

    function exportLocations() {
      if (locations.length === 0) {
        showNotification('No locations to export', 'error');
        return;
      }

      const exportData = {
        trip: currentTrip,
        locations: locations,
        exported_at: new Date().toISOString()
      };

      const dataStr = JSON.stringify(exportData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileName = `trip-${currentTrip.id}-locations.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileName);
      linkElement.click();
      
      showNotification('Location data exported successfully!', 'success');
    }

    // Initialize app
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        // Check authentication
        const { data: { user }, error: userError } = await db.auth.getUser();

        if (!user) {
          showNotification('Please log in to access this page', 'error');
          setTimeout(() => {
            window.location.href = "./index.html";
          }, 2000);
          return;
        }

        currentUser = user;

        // Load trip information
        const tripLoaded = await loadTripInfo();
        if (!tripLoaded) {
          setTimeout(() => {
            window.location.href = "./trip_manager.html";
          }, 3000);
          return;
        }

        // Register device
        await registerDevice();

        // Load location history
        await loadLocationHistory();

        showNotification('Location tracking ready', 'success');

      } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Error initializing tracking system', 'error');
      }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (trackingInterval) {
        clearInterval(trackingInterval);
      }
    });
  </script>
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9JtaoGZvW33eY4XrbXYHpKZGrl3YyFBY&callback=initMap">
  </script>
</body>
</html>